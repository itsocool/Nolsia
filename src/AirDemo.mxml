<?xml version="1.0" encoding="utf-8"?>
<s:WindowedApplication xmlns:fx="http://ns.adobe.com/mxml/2009" 
					   xmlns:s="library://ns.adobe.com/flex/spark" 
					   xmlns:mx="library://ns.adobe.com/flex/mx">
	
	<fx:Script>
		<![CDATA[
			import com.asokorea.util.Excel2Xml;
			
			import mx.controls.Alert;
			import mx.events.CloseEvent;
			
			public var excelHostFile:File = null;
			public var excel2xml:Excel2Xml;
			public var cmdCount:int = 0;
			public var startDate:Date;
			public var finishDate:Date;

			protected function onOpenExcel(event:MouseEvent):void
			{
				excel2xml = new Excel2Xml();
				txaLog.text = "";
				txaError.text = "";

				if(excelHostFile && excelHostFile.exists && !excelHostFile.isDirectory)
				{
					onSelectHostList(null);
				}else
				{
					excelHostFile = File.applicationDirectory;
					excelHostFile.addEventListener(Event.SELECT, onSelectHostList);
					excelHostFile.browseForOpen("Select Host List", Excel2Xml.hostFileTypeFilter);
				}
				startDate = null;
			}
			
			protected function onSelectHostList(event:Event):void
			{
				startDate ||= new Date();
					
				txaLog.text += "Selected File = ";
				txaLog.text += "\n";
				txaLog.text += excelHostFile.nativePath;
				
				excel2xml.addEventListener(Event.INIT, onReady);
				excel2xml.addEventListener(Event.COMPLETE, onComplete);
				excel2xml.addEventListener("notFoundJava", noJavaHandler);
				excel2xml.init(excelHostFile, useJar.selected);
				excel2xml.convertXML(chkSaveXml.selected);
			}
			
			protected function onReady(event:Event):void
			{
				txaLog.text += "Cmd file = " + excel2xml.cmdFile.nativePath;
				txaLog.text += "\n";
				
				if(chkSaveXml.selected){
					txaLog.text += "Save temp Xml file";
				}else{
					txaLog.text += "Get Xml Strng";
				}
				txaLog.text += "\n";
			}
			
			protected function onComplete(event:Event):void
			{
				excel2xml.removeEventListener(Event.INIT, onReady);
				excel2xml.removeEventListener(Event.COMPLETE, onComplete);
				excel2xml.removeEventListener("notFoundJava", noJavaHandler);
				
				if(cmdCount < loopCount.value)
				{
//					txaLog.text += excel2xml.output;
					txaLog.text = excel2xml.error;
					txaError.text = (cmdCount + 1).toString() + " done!";
					txaError.text += "\n";
//					txaLog.text += excel2xmlCmd.error;
//					txaLog.text += excel2xmlCmd.output;
					cmdCount++;
					onSelectHostList(null);
				}else
				{
					cmdCount = 0;
					finishDate = new Date();
					txaError.text = (finishDate.time - startDate.time).toString() + "ms\n"  + txaError.text;
					excel2xml.dispose();
				}
			}
			
			protected function noJavaHandler(event:Event):void
			{
				cmdCount = 0;
				excel2xml = null;
				excelHostFile = null;
				
				Alert.show("Not Found Java\nWould you download now?","Warning", Alert.YES|Alert.NO, null, function(evt:CloseEvent):void{
					if(evt.detail == Alert.YES)
					{
						navigateToURL(new URLRequest("http://java.com/download"));
						return;
					}
				});
				
				excel2xml.dispose();
			}
			
		]]>
	</fx:Script>
	
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
	</fx:Declarations>
	
	<s:VGroup width="100%" height="100%">
		
		<s:Button id="btnOpenExcel" click="onOpenExcel(event)" label="execute"/>
		<s:HGroup>
			<s:CheckBox id="chkSaveXml" label="Save File"/>
			<s:NumericStepper id="loopCount" value="50" stepSize="10" minimum="10" maximum="50" />
			<s:CheckBox id="useJar" label="Use Jar" />
		</s:HGroup>
		<s:TextArea id="txaLog" width="100%" height="100%" />
		<s:TextArea id="txaError" width="100%" height="100%" />
		
	</s:VGroup>
	
</s:WindowedApplication>
